<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√°y T√≠nh Ti√™u Chu·∫©n</title>
    <style>
    /* ======================================== */
    /* === calculator.css - Giao di·ªán ƒêa N·ªÅn T·∫£ng & L·ªãch S·ª≠ === */
    /* ======================================== */
    
    :root {
        --bg-color: #1a1a1a;        
        --calculator-bg: #1f1f1f;   
        --display-bg: #1f1f1f;      
        --key-secondary-bg: #323232;
        --key-primary-bg: #444444;  
        --key-operator-bg: #323232; 
        --key-equal-bg: #4a86c6;    
        --text-primary: #ffffff;    
        --text-secondary: #aaaaaa;  
    }

    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background-color: var(--bg-color);
        margin: 0;
        padding: 20px;
        color: var(--text-primary);
        overflow-x: hidden;
        /* THAY ƒê·ªîI: Ch·∫∑n ch·ªçn vƒÉn b·∫£n */
        user-select: none;
    }

    .container {
        background-color: var(--calculator-bg); 
        padding: 0;
        border-radius: 5px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
        display: flex; /* Cho ph√©p b·ªë c·ª•c ngang (m√°y t√≠nh v√† l·ªãch s·ª≠) */
        max-width: 800px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông t·ªïng th·ªÉ */
        width: 100%;
        /* THAY ƒê·ªîI: NgƒÉn ch·∫∑n h√†nh vi ch·∫°m m·∫∑c ƒë·ªãnh (bao g·ªìm double-tap zoom) */
        touch-action: manipulation;
    }

    .calculator {
        width: 380px;
        overflow: hidden;
        background-color: var(--calculator-bg);
        flex-shrink: 0; /* ƒê·∫£m b·∫£o m√°y t√≠nh gi·ªØ nguy√™n k√≠ch th∆∞·ªõc */
    }

    /* --- Ti√™u ƒë·ªÅ v√† N√∫t L·ªãch s·ª≠ --- */
    .header {
        padding: 10px 20px;
        font-size: 1.1em;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .header .title {
        font-size: 1.2em;
        font-weight: 600;
    }
    .history-toggle {
        font-size: 1.4em;
        cursor: pointer;
        padding: 5px;
        transition: color 0.1s;
    }
    .history-toggle:hover {
        color: #4a86c6;
    }
    
    /* --- M√†n h√¨nh hi·ªÉn th·ªã --- */
    .display-area {
        background-color: var(--display-bg);
        padding: 5px 20px;
        text-align: right;
        min-height: 100px; 
        color: var(--text-primary);
        overflow-y: hidden; 
    }

    #preview {
        font-size: 1.1em;
        color: var(--text-secondary);
        min-height: 25px;
        opacity: 0.8;
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 5px;
        text-align: right;
    }

    #result {
        font-size: 3.5em; 
        font-weight: 300;
        line-height: 1.2;
        overflow-x: hidden;
        white-space: nowrap;
        display: block; 
    }
    
    /* --- H√†ng B·ªô nh·ªõ v√† B√†n ph√≠m --- */
    .memory-row {
        display: flex;
        justify-content: space-around;
        padding: 5px 15px;
        background-color: var(--calculator-bg);
    }
    .memory-row span {
        font-size: 0.85em;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 5px;
        transition: color 0.1s;
    }
    .memory-row span:hover {
        color: var(--text-primary);
    }

    .keys {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1px;
        background-color: var(--calculator-bg); 
        border-top: 1px solid #333;
    }

    .key {
        padding: 15px 0;
        font-size: 1.2em;
        border: none;
        cursor: pointer;
        transition: background-color 0.1s ease;
        color: var(--text-primary);
        text-align: center;
        background-color: var(--key-primary-bg); 
        font-weight: 500;
        /* THAY ƒê·ªîI: NgƒÉn ch·∫∑n h√†nh vi ch·∫°m m·∫∑c ƒë·ªãnh cho n√∫t b·∫•m */
        touch-action: manipulation;
    }

    .key:hover {
        background-color: #555555;
    }

    .key:active {
        background-color: #666666;
    }

    .utility, .operator {
        background-color: var(--key-secondary-bg); 
        color: var(--text-primary);
    }

    .utility:hover, .operator:hover {
        background-color: #444444;
    }

    .equal-sign {
        background-color: var(--key-equal-bg);
        color: var(--text-primary);
        font-weight: 600;
    }

    .equal-sign:hover {
        background-color: #5c9cd8;
    }
    
    /* ======================================== */
    /* === Giao di·ªán L·ªãch s·ª≠ (History) === */
    /* ======================================== */
    
    .history-panel {
        width: 0;
        overflow: hidden;
        background-color: #242424;
        transition: width 0.3s ease-in-out, padding 0.3s ease-in-out;
        border-left: 1px solid #333;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
    }
    
    .history-panel.visible {
        width: 300px; /* Chi·ªÅu r·ªông panel l·ªãch s·ª≠ */
        padding: 10px;
    }
    
    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 5px;
        border-bottom: 1px solid #333;
    }
    .history-header h3 {
        margin: 0;
        font-weight: 500;
        font-size: 1.1em;
    }
    .history-clear {
        color: #ff4d4d;
        cursor: pointer;
        font-size: 0.9em;
        transition: opacity 0.1s;
    }
    .history-clear:hover {
        opacity: 0.8;
    }
    
    #history-list {
        flex-grow: 1;
        overflow-y: auto;
        padding-top: 10px;
        scrollbar-color: #555 #242424;
        scrollbar-width: thin;
    }
    
    .history-item {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: background-color 0.1s;
    }
    .history-item:hover {
        background-color: #383838;
    }
    
    .history-expression {
        font-size: 0.9em;
        color: var(--text-secondary);
        margin-bottom: 2px;
    }
    .history-result {
        font-size: 1.2em;
        font-weight: 600;
    }
    
    /* ======================================== */
    /* === Responsive (T·ªëi ∆∞u cho ƒëi·ªán tho·∫°i) === */
    /* ======================================== */
    @media (max-width: 768px) {
        body {
            padding: 0;
        }
        .container {
            flex-direction: column; /* X·∫øp ch·ªìng m√°y t√≠nh v√† l·ªãch s·ª≠ */
            max-width: 100%;
            border-radius: 0;
            box-shadow: none;
        }
        .calculator {
            width: 100%;
        }
        .history-panel.visible {
            width: 100%;
            height: 40vh; /* L·ªãch s·ª≠ chi·∫øm 40% m√†n h√¨nh khi ·ªü ch·∫ø ƒë·ªô mobile */
        }
        .keys {
            grid-template-columns: repeat(4, 1fr);
            gap: 0;
        }
        .key {
            padding: 12px 0;
            font-size: 1.1em;
        }
    }
</style>
</head>
<body>

    <div class="container">
        <div class="calculator" id="calculatorApp">
            
            <div class="header">
                <span class="title">Calculator</span>
                <span class="history-toggle" id="history-toggle" title="L·ªãch s·ª≠ t√≠nh to√°n">üóò</span>
            </div>

            <div class="display-area">
                <div id="preview"></div>
                <div id="result">0</div>
            </div>

            <div class="memory-row">
                <span>MC</span>
                <span>MR</span>
                <span>M+</span>
                <span>M-</span>
                <span>MS</span>
                <span>M‚ãÅ</span>
            </div>

            <div class="keys">
                <button class="key utility" data-action="percent">%</button>
                <button class="key utility" data-action="clear-entry">CE</button>
                <button class="key utility" data-action="clear">C</button>
                <button class="key utility" data-action="delete">‚å´</button>

                <button class="key utility" data-action="inverse">1/x</button>
                <button class="key utility" data-action="square">x¬≤</button>
                <button class="key utility" data-action="sqrt">‚àöx</button>
                <button class="key operator" data-action="divide">√∑</button>

                <button class="key" data-value="7">7</button>
                <button class="key" data-value="8">8</button>
                <button class="key" data-value="9">9</button>
                <button class="key operator" data-action="multiply">√ó</button>

                <button class="key" data-value="4">4</button>
                <button class="key" data-value="5">5</button>
                <button class="key" data-value="6">6</button>
                <button class="key operator" data-action="subtract">-</button>

                <button class="key" data-value="1">1</button>
                <button class="key" data-value="2">2</button>
                <button class="key" data-value="3">3</button>
                <button class="key operator" data-action="add">+</button>

                <button class="key utility" data-action="sign">¬±</button>
                <button class="key" data-value="0">0</button>
                <button class="key" data-value=".">.</button>
                <button class="key equal-sign" data-action="calculate">=</button>
            </div>
        </div>

        <div class="history-panel" id="history-panel">
            <div class="history-header">
                <h3>History</h3>
                <span class="history-clear" id="history-clear">Clear</span>
            </div>
            <div id="history-list">
                </div>
        </div>
    </div>

    <script>
        /* ======================================== */
        /* === calculator.js - Logic IndexDB, B√†n Ph√≠m, v√† L·ªãch S·ª≠ === */
        /* ======================================== */
        document.addEventListener('DOMContentLoaded', () => {
            const resultDisplay = document.getElementById('result');
            const previewDisplay = document.getElementById('preview');
            const keys = document.querySelector('.keys');
            const historyToggle = document.getElementById('history-toggle');
            const historyPanel = document.getElementById('history-panel');
            const historyList = document.getElementById('history-list');
            const historyClear = document.getElementById('history-clear');

            const MAX_PRECISION_DIGITS = 10; 
            const MAX_DISPLAY_DIGITS = 15; 
            const ERROR_MESSAGE = 'Error';
            
            let displayValue = '0';
            let previewValue = '';
            let firstOperand = null;
            let operator = null;
            let waitingForSecondOperand = false;
            
            let db; // ƒê·ªëi t∆∞·ª£ng IndexDB

            // --- 1. Qu·∫£n l√Ω IndexDB ---
            function openDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('CalculatorDB', 1);

                    request.onupgradeneeded = (e) => {
                        db = e.target.result;
                        db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
                    };

                    request.onsuccess = (e) => {
                        db = e.target.result;
                        resolve(db);
                    };

                    request.onerror = (e) => {
                        console.error("IndexedDB Error:", e.target.error);
                        reject(e.target.error);
                    };
                });
            }

            function saveHistory(expression, result) {
                if (!db) return;

                const transaction = db.transaction(['history'], 'readwrite');
                const store = transaction.objectStore('history');
                const historyItem = {
                    expression: expression,
                    result: result,
                    timestamp: new Date().getTime()
                };

                store.add(historyItem);
            }

            function loadHistory() {
                if (!db) {
                    historyList.innerHTML = '<p style="color: #888; text-align: center; padding-top: 20px;">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ (IndexDB).</p>';
                    return;
                }

                const transaction = db.transaction(['history'], 'readonly');
                const store = transaction.objectStore('history');
                const request = store.getAll();
                historyList.innerHTML = ''; // X√≥a l·ªãch s·ª≠ c≈©
                
                request.onsuccess = (e) => {
                    const history = e.target.result.reverse(); // L·∫•y l·ªãch s·ª≠ m·ªõi nh·∫•t tr∆∞·ªõc
                    
                    if (history.length === 0) {
                        historyList.innerHTML = '<p style="color: #888; text-align: center; padding-top: 20px;">Ch∆∞a c√≥ l·ªãch s·ª≠.</p>';
                        return;
                    }

                    history.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        div.setAttribute('data-result', item.result);
                        div.innerHTML = `
                            <div class="history-expression">${item.expression}</div>
                            <div class="history-result">${parseFloat(item.result).toLocaleString('en-US', { maximumSignificantDigits: MAX_DISPLAY_DIGITS })}</div>
                        `;
                        div.addEventListener('click', () => {
                            displayValue = item.result;
                            firstOperand = null; 
                            operator = null;
                            waitingForSecondOperand = true;
                            previewValue = '';
                            updateDisplay();
                        });
                        historyList.appendChild(div);
                    });
                };

                request.onerror = (e) => {
                    console.error("Error loading history:", e.target.error);
                };
            }
            
            function clearHistory() {
                if (!db) return;

                const transaction = db.transaction(['history'], 'readwrite');
                const store = transaction.objectStore('history');
                const request = store.clear();

                request.onsuccess = () => {
                    loadHistory();
                };
            }

            // --- 2. Logic M√°y T√≠nh (Gi·ªØ nguy√™n v√† c·∫£i ti·∫øn) ---

            function applyRounding(number) {
                if (typeof number !== 'number' || isNaN(number) || !isFinite(number)) return String(number);
                const factor = Math.pow(10, MAX_PRECISION_DIGITS);
                return String(Math.round(number * factor) / factor);
            }

            function updateDisplay() {
                if (!isNaN(parseFloat(displayValue))) {
                    const number = parseFloat(displayValue);

                    if (displayValue === ERROR_MESSAGE) {
                        resultDisplay.textContent = ERROR_MESSAGE;
                    }
                    else if (displayValue.includes('e') || 
                        (Math.abs(number) >= Math.pow(10, MAX_DISPLAY_DIGITS)) || 
                        (Math.abs(number) > 0 && Math.abs(number) < Math.pow(10, -10))) 
                    {
                        resultDisplay.textContent = number.toExponential(MAX_DISPLAY_DIGITS - 6);
                    } else {
                        // ƒê·ªãnh d·∫°ng s·ªë c√≥ d·∫•u ph·∫©y ph√¢n c√°ch h√†ng ngh√¨n
                        resultDisplay.textContent = number.toLocaleString('en-US', {
                            maximumSignificantDigits: MAX_DISPLAY_DIGITS
                        });
                        if (displayValue.endsWith('.') && !displayValue.includes('e')) {
                             resultDisplay.textContent += '.';
                        }
                    }
                } else {
                    resultDisplay.textContent = displayValue;
                }
                
                previewDisplay.textContent = previewValue;
            }
            
            function clearAll() { // N√∫t C
                displayValue = '0';
                previewValue = '';
                firstOperand = null;
                operator = null;
                waitingForSecondOperand = false;
                updateDisplay();
            }
            
            function clearEntry() { // N√∫t CE
                displayValue = '0';
                updateDisplay();
            }
            
            function inputDigit(digit) {
                if (waitingForSecondOperand === true) {
                    displayValue = digit;
                    waitingForSecondOperand = false;
                } else {
                    if (displayValue === ERROR_MESSAGE) {
                        displayValue = digit;
                    } else {
                        if (displayValue.length < MAX_DISPLAY_DIGITS + 5) {
                            displayValue = displayValue === '0' ? digit : displayValue + digit;
                        }
                    }
                }
                updateDisplay();
            }

            function inputDecimal(dot) {
                if (waitingForSecondOperand === true) {
                    displayValue = '0.';
                    waitingForSecondOperand = false;
                } else if (!displayValue.includes(dot)) {
                    displayValue += dot;
                }
                updateDisplay();
            }

            function calculate(first, second, op) {
                first = parseFloat(first);
                second = parseFloat(second);
                
                if (op === '+') return first + second;
                if (op === '-') return first - second;
                if (op === '√ó') return first * second;
                if (op === '√∑') {
                    if (second === 0) return ERROR_MESSAGE;
                    return first / second;
                }
                return second;
            }

            function handleOperator(nextOperator) {
                const inputValue = parseFloat(displayValue);

                if (operator && waitingForSecondOperand) {
                    operator = nextOperator;
                    previewValue = `${firstOperand} ${operator}`;
                    updateDisplay();
                    return;
                }

                if (firstOperand === null) {
                    firstOperand = inputValue;
                } else if (operator) {
                    const result = calculate(firstOperand, inputValue, operator);
                    
                    if (result === ERROR_MESSAGE) {
                        displayValue = result;
                        clearErrorState();
                        return;
                    }
                    
                    displayValue = applyRounding(result);
                    firstOperand = parseFloat(displayValue);
                }

                waitingForSecondOperand = true;
                operator = nextOperator;
                previewValue = `${firstOperand} ${operator}`;
                updateDisplay();
            }

            function handleCalculate() {
                if (firstOperand === null || operator === null) {
                    return;
                }

                const inputValue = parseFloat(displayValue);
                
                // L∆∞u ph√©p t√≠nh tr∆∞·ªõc khi t√≠nh to√°n
                const expression = `${firstOperand} ${operator} ${inputValue}`;
                
                const result = calculate(firstOperand, inputValue, operator);

                if (result === ERROR_MESSAGE) {
                    displayValue = result;
                    clearErrorState();
                } else {
                    displayValue = applyRounding(result);
                    
                    previewValue = `${expression} =`;
                    
                    // L∆ØU V√ÄO INDEXDB
                    saveHistory(previewValue, displayValue);
                    
                    firstOperand = parseFloat(displayValue);
                    operator = null; 
                    waitingForSecondOperand = true;
                }
                updateDisplay();
                loadHistory(); // T·∫£i l·∫°i l·ªãch s·ª≠ sau khi t√≠nh to√°n
            }
            
            function clearErrorState() {
                firstOperand = null;
                operator = null;
                waitingForSecondOperand = false;
                previewValue = '';
                updateDisplay();
            }

            function deleteLastDigit() {
                if (displayValue === ERROR_MESSAGE || waitingForSecondOperand) return;
                
                displayValue = displayValue.slice(0, -1);
                if (displayValue.length === 0 || displayValue === '-') {
                    displayValue = '0';
                }
                updateDisplay();
            }
            
            function toggleSign() {
                if (displayValue === '0' || displayValue === ERROR_MESSAGE) return;

                displayValue = applyRounding(parseFloat(displayValue) * -1);
                updateDisplay();
            }
            
            function calculatePercent() {
                if (displayValue === ERROR_MESSAGE) return;
                const currentValue = parseFloat(displayValue);

                if (firstOperand === null) {
                    displayValue = applyRounding(currentValue / 100);
                } else {
                    const percentValue = firstOperand * (currentValue / 100);
                    displayValue = applyRounding(percentValue);
                    waitingForSecondOperand = false; 
                }
                updateDisplay();
            }
            
            function calculateSingleOperand(action) {
                if (displayValue === ERROR_MESSAGE) return;
                const currentValue = parseFloat(displayValue);
                let result;
                let expression;
                
                switch (action) {
                    case 'square': 
                        result = currentValue * currentValue;
                        expression = `sqr(${currentValue}) =`;
                        break;
                    case 'sqrt': 
                        if (currentValue < 0) {
                            displayValue = ERROR_MESSAGE;
                            clearErrorState();
                            return;
                        }
                        result = Math.sqrt(currentValue);
                        expression = `‚àö(${currentValue}) =`;
                        break;
                    case 'inverse': 
                        if (currentValue === 0) {
                            displayValue = ERROR_MESSAGE;
                            clearErrorState();
                            return;
                        }
                        result = 1 / currentValue;
                        expression = `1/(${currentValue}) =`;
                        break;
                    default:
                        return;
                }
                
                displayValue = applyRounding(result);
                previewValue = expression;
                
                // L∆ØU V√ÄO INDEXDB
                saveHistory(previewValue, displayValue);
                
                firstOperand = null;
                operator = null; 
                waitingForSecondOperand = true;
                updateDisplay();
                loadHistory(); // T·∫£i l·∫°i l·ªãch s·ª≠ sau khi t√≠nh to√°n
            }


            // --- 3. X·ª≠ l√Ω S·ª± ki·ªán N√∫t B·∫•m & B√†n Ph√≠m ---
            
            // H√†m trung gian x·ª≠ l√Ω c√°c h√†nh ƒë·ªông
            function handleAction(action, value) {
                if (value) {
                    if (value === '.') {
                        inputDecimal('.');
                    } else {
                        inputDigit(value);
                    }
                } 
                else if (action) {
                    switch (action) {
                        case 'clear':
                            clearAll();
                            break;
                        case 'clear-entry':
                            clearEntry();
                            break;
                        case 'delete':
                            deleteLastDigit();
                            break;
                        case 'sign':
                            toggleSign();
                            break;
                        case 'percent':
                            calculatePercent();
                            break;
                        case 'square':
                        case 'sqrt':
                        case 'inverse':
                            calculateSingleOperand(action);
                            break;
                        case 'calculate':
                            handleCalculate();
                            break;
                        case 'divide':
                        case 'multiply':
                        case 'subtract':
                        case 'add':
                            // L·∫•y k√Ω hi·ªáu t·ª´ n·ªôi dung n√∫t (√∑, √ó, -, +)
                            const button = document.querySelector(`[data-action="${action}"]`);
                            handleOperator(button ? button.textContent : action); 
                            break;
                    }
                }
            }

            // X·ª≠ l√Ω click chu·ªôt
            keys.addEventListener('click', (event) => {
                const { target } = event;
                if (!target.matches('button')) return; 

                const { action, value } = target.dataset;
                handleAction(action, value);
            });

            // X·ª≠ l√Ω s·ª± ki·ªán b√†n ph√≠m PC
            document.addEventListener('keydown', (e) => {
                e.preventDefault(); // NgƒÉn h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát (v√≠ d·ª•: Space bar)

                const keyMap = {
                    '0': '0', '1': '1', '2': '2', '3': '3', '4': '4',
                    '5': '5', '6': '6', '7': '7', '8': '8', '9': '9',
                    '.': '.',
                    'Enter': 'calculate',
                    '=': 'calculate',
                    '+': 'add',
                    '-': 'subtract',
                    '*': 'multiply',
                    '/': 'divide',
                    'Delete': 'clear', // Ph√≠m Delete = C
                    'Backspace': 'delete' // Ph√≠m Backspace = ‚å´
                    // Kh√¥ng c√≥ ph√≠m c·ª©ng cho CE, % hay c√°c h√†m kh√°c (tr·ª´ khi l·∫≠p tr√¨nh th√™m)
                };

                const action = keyMap[e.key];

                if (action === 'calculate' || action === 'add' || action === 'subtract' || action === 'multiply' || action === 'divide' || action === 'clear' || action === 'delete') {
                    handleAction(action);
                } else if (action) {
                    handleAction(null, action); // X·ª≠ l√Ω c√°c n√∫t s·ªë v√† d·∫•u th·∫≠p ph√¢n
                }
            });


            // --- 4. X·ª≠ l√Ω L·ªãch S·ª≠ ---
            
            historyToggle.addEventListener('click', () => {
                historyPanel.classList.toggle('visible');
                // T·∫£i l·∫°i l·ªãch s·ª≠ m·ªói khi m·ªü panel
                if (historyPanel.classList.contains('visible')) {
                    loadHistory();
                }
            });
            
            historyClear.addEventListener('click', clearHistory);

            // --- Kh·ªüi t·∫°o ---
            openDatabase().then(() => {
                loadHistory();
                updateDisplay();
            });
        });
    </script>
</body>
</html>
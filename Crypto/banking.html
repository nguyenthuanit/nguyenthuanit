<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ng√¢n H√†ng Trung T√¢m & R√∫t Ti·ªÅn - NMT VIP BO</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { justify-content: flex-start; align-items: center; background-image: radial-gradient(circle at top, #1a1c23 0%, #0b0e11 100%); padding: 15px; overflow-y: auto; }
        .bank-container { width: 100%; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        
        /* B·ªë c·ª•c 2 c·ªôt cho m√†n PC, 1 c·ªôt cho Mobile */
        .grid-layout { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .grid-layout { grid-template-columns: 1fr 1fr; } }

        /* Panel chung */
        .panel-box { background: var(--bg-panel); border-radius: 12px; border: 1px solid var(--border); padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .panel-title { color: var(--accent); font-size: 18px; margin-bottom: 20px; text-align: center; text-transform: uppercase; letter-spacing: 1px;}
        
        /* C·ªôt Ng√¢n h√†ng */
        .vault-balance { font-size: 40px; font-weight: bold; color: #fff; margin: 10px 0; text-align: center; font-family: 'Courier New', monospace; }
        .stats-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-base); padding: 15px 10px; border-radius: 8px; border: 1px dashed var(--border); text-align: center; }
        .flow-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .flow-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-base); padding: 12px; border-radius: 8px; font-size: 13px; }
        .thu { color: var(--green); border-left: 3px solid var(--green); }
        .chi { color: var(--red); border-left: 3px solid var(--red); }
        
        /* C·ªôt R√∫t ti·ªÅn */
        .balance-box { background: rgba(246, 70, 93, 0.1); border: 1px dashed var(--red); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
        .balance-box p { color: var(--text-muted); font-size: 13px; margin-bottom: 5px; }
        .balance-box h2 { color: var(--red); font-size: 24px; }
        select.styled-select { width: 100%; background: var(--bg-base); border: 1px solid var(--border); color: var(--accent); padding: 14px; border-radius: 6px; outline: none; font-size: 15px; cursor: pointer; }
        .input-group label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 5px; }
        .input-group input { width: 100%; background: var(--bg-base); border: 1px solid var(--border); color: white; padding: 14px; border-radius: 6px; outline: none; box-sizing: border-box; }
        input[readonly] { background-color: rgba(255, 255, 255, 0.05) !important; color: var(--text-muted) !important; cursor: not-allowed; border: 1px dashed var(--border) !important; }
        
        .loading-overlay { text-align: center; padding: 30px; color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const playerId = urlParams.get('id');
        if (!playerId || playerId.trim() === "") window.location.replace('login.html'); 
    </script>

    <div class="bank-container">
        
        <div class="grid-layout">
            <div class="panel-box">
                <h2 class="panel-title">üí∏ L·ªánh R√∫t Ti·ªÅn C·ªßa <span style="color:white" id="display-id">...</span></h2>
                
                <div class="balance-box">
                    <p>S·ªë d∆∞ kh·∫£ d·ª•ng hi·ªán t·∫°i</p>
                    <h2 id="available-balance">$0.00</h2>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label>S·ªë ti·ªÅn c·∫ßn r√∫t (USD)</label>
                    <input type="number" id="withdraw-amount" placeholder="T·ªëi thi·ªÉu $50" oninput="calcVndReceive()">
                    <p style="text-align: right; font-size: 12px; color: var(--text-muted); margin-top: 5px;">Th·ª±c nh·∫≠n: <span id="vnd-receive" style="color: var(--green); font-weight: bold;">0 ‚Ç´</span></p>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Ng√¢n h√†ng nh·∫≠n</label>
                    <select id="bank-name" class="styled-select">
                        <option value="Vietcombank">Vietcombank (VCB)</option>
                        <option value="Techcombank">Techcombank (TCB)</option>
                        <option value="MB Bank">MB Bank (MB)</option>
                        <option value="VietinBank">VietinBank</option>
                    </select>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label>S·ªë t√†i kho·∫£n</label>
                    <input type="text" id="account-number" value="0987654321999" readonly>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label>T√™n ch·ªß t√†i kho·∫£n</label>
                    <input type="text" id="account-name" value="NGUYEN VAN A" readonly>
                </div>

                <button id="btn-submit-withdraw" class="btn-buy" style="width: 100%; padding: 15px; font-size: 16px; border-radius: 8px; margin-top: 10px; background: var(--red); color: white;" onclick="checkAdminBeforeWithdraw()">X√°c Nh·∫≠n R√∫t Ti·ªÅn</button>
            </div>

            <div class="panel-box">
                <h2 class="panel-title">üè¶ T·ªîNG QU·ª∏ S√ÄN BO</h2>
                <div class="vault-balance" id="treasury-balance">$0.00</div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <span id="net-profit-badge" style="padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; border: 1px solid var(--text-muted);">ƒêang ƒë·ªìng b·ªô...</span>
                </div>

                <div class="stats-grid-2">
                    <div class="stat-card">
                        <h4 style="color: var(--text-muted); font-size: 11px;">S√ÄN THU (KH√ÅCH THUA)</h4>
                        <div id="total-in" style="color: var(--green); font-weight: bold; font-size: 16px; margin-top: 5px;">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h4 style="color: var(--text-muted); font-size: 11px;">S√ÄN CHI (KH√ÅCH TH·∫ÆNG/R√öT)</h4>
                        <div id="total-out" style="color: var(--red); font-weight: bold; font-size: 16px; margin-top: 5px;">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h4 style="color: var(--text-muted); font-size: 11px;">T·ªîNG N·∫†P M·ªöI</h4>
                        <div id="total-deposit" style="color: var(--accent); font-weight: bold; font-size: 16px; margin-top: 5px;">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h4 style="color: var(--text-muted); font-size: 11px;">T·ªîNG USER</h4>
                        <div id="total-users" style="color: #fff; font-weight: bold; font-size: 16px; margin-top: 5px;">0</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 10px; font-size: 14px; color: var(--text-muted); border-bottom: 1px solid var(--border); padding-bottom: 10px;">L·ªäCH S·ª¨ D√íNG TI·ªÄN (LIVE)</h3>
                <div id="flow-list" class="flow-list">
                    <div class="loading-overlay">ƒêang t·∫£i d·ªØ li·ªáu ƒë√°m m√¢y...</div>
                </div>
            </div>
        </div>

        <button class="btn-cancel" style="padding: 15px; font-size: 16px; border-radius: 8px; width: 100%;" onclick="goBack()">‚¨Ö Quay L·∫°i S√†n Giao D·ªãch</button>
    </div>

    <div id="admin-auth-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--bg-panel); border-radius: 12px; border: 1px solid var(--border); padding: 25px; width: 90%; max-width: 350px; text-align: center;">
            <h3 style="color: var(--red); margin-bottom: 15px;">üîí KH√ìA DUY·ªÜT R√öT TI·ªÄN</h3>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">Ch·ª©c nƒÉng r√∫t ti·ªÅn b·ªã kh√≥a. C·∫ßn Admin nh·∫≠p m·∫≠t kh·∫©u h·ªá th·ªëng ƒë·ªÉ duy·ªát l·ªánh.</p>
            <input type="password" id="admin-secret-key" placeholder="Nh·∫≠p m·∫≠t kh·∫©u duy·ªát l·ªánh..." style="width: 100%; background: var(--bg-base); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 6px; outline: none; margin-bottom: 15px; text-align: center;">
            <div style="display: flex; gap: 10px;">
                <button class="btn-cancel" style="flex: 1; padding: 10px; border-radius: 6px;" onclick="document.getElementById('admin-auth-modal').style.display='none'">H·ªßy</button>
                <button class="btn-buy" style="flex: 1; border: none; border-radius: 6px; color: white; font-weight: bold; background: var(--red);" onclick="verifyAdminKey()">DUY·ªÜT L·ªÜNH</button>
            </div>
        </div>
    </div>

    <script>
        // === THAY LINK GOOGLE SCRIPT M·ªöI V√ÄO ƒê√ÇY ===
        const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbypWHtNHG5Svb6GkaAddQzwtxdShbJkPN_IYLKQEDJjgN71LAI-_6plLg-RJTsLEgsDpw/exec";
        const EXCHANGE_RATE = 25000;
        const INITIAL_FUNDS = 1000000.00; // V·ªën ban ƒë·∫ßu c·ªßa h·ªá th·ªëng
        
        let personalBalance = 0;
        let pendingWithdrawAmount = 0;
        let isAdminAuthed = false;

        document.getElementById('display-id').innerText = playerId;

        // 1. T·∫¢I D·ªÆ LI·ªÜU T·ªîNG H·ª¢P T·ª™ CLOUD
        async function fetchAllData() {
            try {
                // L·∫•y s·ªë d∆∞ c√° nh√¢n
                const balRes = await fetch(GOOGLE_SHEET_URL, {
                    method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action: "GET_BALANCE", id: playerId })
                });
                const balData = await balRes.json();
                if (balData.status === "success") {
                    personalBalance = parseFloat(balData.balance) || 0;
                    document.getElementById('available-balance').innerText = "$" + personalBalance.toLocaleString(undefined, {minimumFractionDigits: 2});
                }

                // L·∫•y Th·ªëng k√™ Ng√¢n h√†ng
                const bankRes = await fetch(GOOGLE_SHEET_URL, {
                    method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action: "GET_BANK_STATS", id: playerId })
                });
                const bankData = await bankRes.json();
                if (bankData.status === "success") {
                    updateBankUI(bankData.stats, bankData.history);
                }
            } catch (e) { console.warn("L·ªói ƒë·ªìng b·ªô Cloud"); }
        }

        // C·∫≠p nh·∫≠t giao di·ªán Ng√¢n h√†ng
        function updateBankUI(stats, history) {
            const currentVault = INITIAL_FUNDS + stats.totalIn + stats.totalDeposit - stats.totalOut;
            const f = (v) => "$" + v.toLocaleString(undefined, {minimumFractionDigits: 2});
            
            document.getElementById('treasury-balance').innerText = f(currentVault);
            document.getElementById('total-in').innerText = "+" + f(stats.totalIn);
            document.getElementById('total-out').innerText = "-" + f(stats.totalOut);
            document.getElementById('total-deposit').innerText = "+" + f(stats.totalDeposit);
            document.getElementById('total-users').innerText = stats.totalUsers;

            const net = stats.totalIn - (stats.totalOut - stats.totalDeposit); // ∆Ø·ªõc t√≠nh l·ª£i nhu·∫≠n r√≤ng
            const badge = document.getElementById('net-profit-badge');
            badge.innerText = net >= 0 ? `L·ª£i nhu·∫≠n r√≤ng: +${f(net)}` : `S√†n ƒëang l·ªó: ${f(net)}`;
            badge.style.border = `1px solid ${net >= 0 ? 'var(--green)' : 'var(--red)'}`;
            badge.style.color = net >= 0 ? 'var(--green)' : 'var(--red)';

            // Render danh s√°ch giao d·ªãch
            const listContainer = document.getElementById('flow-list');
            listContainer.innerHTML = '';
            history.forEach(row => {
                let rowClass = "thu";
                if (row.action.includes("C∆∞·ª£c")) {
                    rowClass = row.result === "TH·∫ÆNG" ? "chi" : "thu";
                } else if (row.action === "R√öT TI·ªÄN") { rowClass = "chi"; }

                const displayAmt = row.action.includes("C∆∞·ª£c") && row.result === "TH·∫ÆNG" ? row.pnl : row.amount;

                listContainer.innerHTML += `
                    <div class="flow-item ${rowClass}">
                        <div><strong>${row.action} (${row.id})</strong><br><small style="color:var(--text-muted)">${row.time}</small></div>
                        <div style="font-weight:bold">${rowClass === 'thu' ? '+' : '-'}$${Math.abs(displayAmt).toFixed(2)}</div>
                    </div>`;
            });
        }

        // T·ª± ƒë·ªông qu√©t 5 gi√¢y / l·∫ßn
        setInterval(fetchAllData, 5000);
        window.onload = fetchAllData;

        // --- X·ª¨ L√ù R√öT TI·ªÄN C√ì KH√ìA ADMIN ---
        function calcVndReceive() {
            const usd = parseFloat(document.getElementById('withdraw-amount').value) || 0;
            document.getElementById('vnd-receive').innerText = (usd * EXCHANGE_RATE).toLocaleString() + " ‚Ç´";
        }

        function checkAdminBeforeWithdraw() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            if (isNaN(amount) || amount < 50) return alert("S·ªë ti·ªÅn r√∫t t·ªëi thi·ªÉu l√† $50.");
            if (amount > personalBalance) return alert("S·ªë d∆∞ kh√¥ng ƒë·ªß ƒë·ªÉ r√∫t!");

            pendingWithdrawAmount = amount;

            if (isAdminAuthed) {
                processWithdraw();
            } else {
                document.getElementById('admin-secret-key').value = '';
                document.getElementById('admin-auth-modal').style.display = 'flex';
            }
        }

        function verifyAdminKey() {
            const key = document.getElementById('admin-secret-key').value;
            // M·∫¨T KH·∫®U ƒê·ªÇ DUY·ªÜT L·ªÜNH R√öT L√Ä: adminr√∫t
            if (key === "adminr√∫t") {
                document.getElementById('admin-auth-modal').style.display = 'none';
                isAdminAuthed = true;
                processWithdraw();
            } else {
                alert("‚ùå M·∫≠t kh·∫©u duy·ªát l·ªánh sai!");
            }
        }

        async function processWithdraw() {
            const bankName = document.getElementById('bank-name').value;
            const accNum = document.getElementById('account-number').value;
            const btnSubmit = document.getElementById('btn-submit-withdraw');

            btnSubmit.disabled = true;
            btnSubmit.innerText = "ƒêang x·ª≠ l√Ω tr√™n Cloud...";

            // Tr·ª´ ti·ªÅn t·∫°m th·ªùi tr√™n UI
            personalBalance -= pendingWithdrawAmount;
            document.getElementById('available-balance').innerText = "$" + personalBalance.toLocaleString(undefined, {minimumFractionDigits: 2});

            // G·ª≠i d·ªØ li·ªáu l√™n Sheets
            const payload = {
                action: "SAVE_TRANSACTION",
                id: playerId,
                time: new Date().toLocaleString("vi-VN"),
                tradeAction: "R√öT TI·ªÄN",
                amount: pendingWithdrawAmount,
                result: "CH·ªú DUY·ªÜT",
                pnl: -pendingWithdrawAmount,
                balance: personalBalance.toFixed(2),
                note: `NH: ${bankName} | STK: ${accNum}`
            };

            try {
                await fetch(GOOGLE_SHEET_URL, {
                    method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                alert(`‚úÖ R√∫t th√†nh c√¥ng $${pendingWithdrawAmount}. D·ªØ li·ªáu ƒë√£ ghi l√™n Cloud!`);
                document.getElementById('withdraw-amount').value = '';
                calcVndReceive();
                fetchAllData(); // T·∫£i l·∫°i ngay l·∫≠p t·ª©c ƒë·ªÉ d√≤ng ti·ªÅn ch·∫°y
            } catch (err) { alert("L·ªói m·∫°ng, vui l√≤ng th·ª≠ l·∫°i!"); }

            btnSubmit.disabled = false;
            btnSubmit.innerText = "X√°c Nh·∫≠n R√∫t Ti·ªÅn";
        }

        function goBack() { window.location.href = `index.html?id=${playerId}`; }
    </script>
</body>
</html>
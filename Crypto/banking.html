<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ng√¢n H√†ng Trung T√¢m Cloud - NMT VIP BO</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            justify-content: flex-start;
            align-items: center;
            background-image: radial-gradient(circle at top, #1a1c23 0%, #0b0e11 100%);
            padding: 20px;
            overflow-y: auto;
        }
        .bank-container { width: 100%; max-width: 900px; margin: 20px auto; }
        .vault-header {
            background: var(--bg-panel); padding: 30px; border-radius: 12px;
            border: 1px solid var(--accent); text-align: center; margin-bottom: 20px;
        }
        .vault-balance { font-size: 48px; font-weight: bold; color: #fff; margin: 10px 0; font-family: 'Courier New', monospace; }
        .stats-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-panel); padding: 20px 10px; border-radius: 10px; border: 1px solid var(--border); text-align: center; }
        .flow-section { background: var(--bg-panel); border-radius: 12px; border: 1px solid var(--border); padding: 20px; }
        .flow-list { display: flex; flex-direction: column; gap: 10px; max-height: 500px; overflow-y: auto; }
        .flow-item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-base); padding: 12px 15px; border-radius: 8px; font-size: 14px;
        }
        .thu { color: var(--green); border-left: 4px solid var(--green); }
        .chi { color: var(--red); border-left: 4px solid var(--red); }
        .loading-overlay { text-align: center; padding: 50px; color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

    <div class="bank-container">
        <div class="vault-header">
            <div style="color: var(--accent); letter-spacing: 2px;">üè¶ T·ªîNG QU·ª∏ H·ªÜ TH·ªêNG (REAL-TIME)</div>
            <div class="vault-balance" id="treasury-balance">$0.00</div>
            <div id="net-profit-badge" style="display:inline-block; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold;">ƒêang ƒë·ªìng b·ªô...</div>
        </div>

        <div class="stats-grid-4">
            <div class="stat-card">
                <h4 style="color: var(--text-muted); font-size: 11px;">S√ÄN THU (KH√ÅCH THUA)</h4>
                <div id="total-in" style="color: var(--green); font-weight: bold;">$0.00</div>
            </div>
            <div class="stat-card">
                <h4 style="color: var(--text-muted); font-size: 11px;">S√ÄN CHI (KH√ÅCH TH·∫ÆNG)</h4>
                <div id="total-out" style="color: var(--red); font-weight: bold;">$0.00</div>
            </div>
            <div class="stat-card">
                <h4 style="color: var(--text-muted); font-size: 11px;">KH√ÅCH N·∫†P M·ªöI</h4>
                <div id="total-deposit" style="color: var(--accent); font-weight: bold;">$0.00</div>
            </div>
            <div class="stat-card">
                <h4 style="color: var(--text-muted); font-size: 11px;">T·ªîNG USER</h4>
                <div id="total-users" style="color: #fff; font-weight: bold;">0</div>
            </div>
        </div>

        <div class="flow-section">
            <h3 style="margin-bottom: 15px; font-size: 16px;">L·ªäCH S·ª¨ D√íNG TI·ªÄN TR√äN GOOGLE SHEETS</h3>
            <div id="flow-list" class="flow-list">
                <div class="loading-overlay">ƒêang truy xu·∫•t d·ªØ li·ªáu ƒë√°m m√¢y...</div>
            </div>
        </div>

        <a href="index.html" style="display: block; text-align: center; margin-top: 20px; color: var(--text-muted); text-decoration: none;">‚¨Ö Quay l·∫°i S√†n Giao D·ªãch</a>
    </div>

    <script>
        // C·∫•u h√¨nh ƒë·ªìng b·ªô Cloud
        const CLOUD_URL = "https://script.google.com/macros/s/AKfycbzENF5j2O8npZIRGKr_a7RGYnJwWB8v5sv8ThsvwxPSmJ8ykQDaT4ws4EW9kbQSkc-S/exec";
        const INITIAL_FUNDS = 1000000.00; // V·ªën g·ªëc ban ƒë·∫ßu c·ªßa s√†n

        async function refreshBankingData() {
            try {
                const response = await fetch(CLOUD_URL);
                const cloudData = await response.json();

                if (cloudData.status === "success") {
                    updateUI(cloudData.history, cloudData.users);
                }
            } catch (error) {
                console.error("L·ªói k·∫øt n·ªëi Cloud:", error);
            }
        }

        function updateUI(history, users) {
            let s_in = 0, s_out = 0, s_dep = 0;
            let currentVault = INITIAL_FUNDS;
            const listContainer = document.getElementById('flow-list');
            listContainer.innerHTML = '';

            // Duy·ªát d·ªØ li·ªáu t·ª´ tab 'data' tr√™n Sheets
            // C·∫•u tr√∫c m·∫£ng row: [Th·ªùi gian, H√†nh ƒë·ªông, S·ªë ti·ªÅn, K·∫øt qu·∫£, PnL, S·ªë d∆∞, Ghi ch√∫, ..., ID]
            history.reverse().forEach(row => {
                const action = row[1];
                const amount = parseFloat(row[2]) || 0;
                const result = row[3];
                const pnl = parseFloat(row[4]) || 0;
                const pID = row[10] || "·∫®n danh";

                let rowClass = "thu";
                if (action.includes("C∆∞·ª£c")) {
                    if (result === "TH·∫ÆNG") { s_out += Math.abs(pnl); currentVault -= Math.abs(pnl); rowClass = "chi"; }
                    else if (result === "THUA") { s_in += amount; currentVault += amount; }
                } else if (action === "N·∫†P TI·ªÄN") {
                    s_dep += amount; currentVault += amount;
                } else if (action === "R√öT TI·ªÄN") {
                    currentVault -= Math.abs(amount); rowClass = "chi";
                }

                listContainer.innerHTML += `
                    <div class="flow-item ${rowClass}">
                        <div><strong>${action} (${pID})</strong><br><small>${row[0]}</small></div>
                        <div style="font-weight:bold">${rowClass === 'thu' ? '+' : '-'}$${Math.abs(amount).toFixed(2)}</div>
                    </div>`;
            });

            // C·∫≠p nh·∫≠t c√°c con s·ªë th·ªëng k√™
            const f = (v) => "$" + v.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('treasury-balance').innerText = f(currentVault);
            document.getElementById('total-in').innerText = "+" + f(s_in);
            document.getElementById('total-out').innerText = "-" + f(s_out);
            document.getElementById('total-deposit').innerText = "+" + f(s_dep);
            document.getElementById('total-users').innerText = users.length;

            // C·∫≠p nh·∫≠t Badge l·ª£i nhu·∫≠n r√≤ng
            const net = s_in - s_out;
            const badge = document.getElementById('net-profit-badge');
            badge.innerText = net >= 0 ? `L·ª£i nhu·∫≠n r√≤ng: +${f(net)}` : `S√†n ƒëang l·ªó: ${f(net)}`;
            badge.style.border = `1px solid ${net >= 0 ? 'var(--green)' : 'var(--red)'}`;
            badge.style.color = net >= 0 ? 'var(--green)' : 'var(--red)';
        }

        // T·ª± ƒë·ªông qu√©t Cloud m·ªói 5 gi√¢y (Kh√¥ng d√πng LocalStorage)
        setInterval(refreshBankingData, 5000);
        window.onload = refreshBankingData;
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√∫t Ti·ªÅn - NMT VIP BO</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* T√πy ch·ªânh giao di·ªán trang r√∫t ti·ªÅn */
        body {
            justify-content: center;
            align-items: center;
            background-image: radial-gradient(circle at center, #181a20 0%, #0b0e11 100%);
        }
        .withdraw-container {
            width: 100%;
            max-width: 450px;
            background: var(--bg-panel);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            animation: slideDown 0.4s ease-out;
            position: relative;
        }
        .header-title {
            text-align: center;
            color: var(--text-main);
            margin-bottom: 25px;
            font-size: 22px;
        }
        .header-title span { color: var(--red); }
        .balance-box {
            background: rgba(246, 70, 93, 0.1);
            border: 1px dashed var(--red);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        .balance-box p { color: var(--text-muted); font-size: 13px; margin-bottom: 5px; }
        .balance-box h2 { color: var(--red); font-size: 24px; }

        /* T√πy ch·ªânh Select Box */
        select.styled-select {
            width: 100%;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--accent);
            padding: 15px;
            border-radius: 6px;
            outline: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            appearance: none; /* ·∫®n m≈©i t√™n m·∫∑c ƒë·ªãnh tr√™n m·ªôt s·ªë tr√¨nh duy·ªát */
        }
        select.styled-select:focus { border-color: var(--accent); }
        select.styled-select option { background: var(--bg-base); color: var(--text-main); font-weight: normal; }

        /* T√πy ch·ªânh Input Readonly (Kh√≥a kh√¥ng cho s·ª≠a) */
        input[readonly] {
            background-color: rgba(255, 255, 255, 0.05) !important;
            color: var(--text-muted) !important;
            cursor: not-allowed;
            border: 1px dashed var(--border) !important;
        }

        /* --- CSS CHO H·ªÜ TH·ªêNG POPUP (MODAL) --- */
        .custom-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(4px);
            z-index: 2000; display: none; justify-content: center; align-items: center;
        }
        .popup-content {
            background: var(--bg-panel); width: 90%; max-width: 380px;
            border-radius: 12px; border: 1px solid var(--border);
            padding: 25px; text-align: center; animation: zoomIn 0.3s ease-out;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .popup-icon { font-size: 50px; margin-bottom: 10px; }
        .popup-title { margin-bottom: 10px; font-size: 18px; color: var(--text-main); }
        .popup-desc { color: var(--text-muted); font-size: 14px; margin-bottom: 20px; line-height: 1.5; }
        .popup-actions { display: flex; gap: 10px; }
        
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="withdraw-container">
        <h2 class="header-title">üí∏ L·ªánh <span>R√∫t Ti·ªÅn</span></h2>

        <div class="balance-box">
            <p>S·ªë d∆∞ kh·∫£ d·ª•ng</p>
            <h2 id="available-balance">$0.00</h2>
        </div>

        <div class="input-group">
            <label>S·ªë ti·ªÅn c·∫ßn r√∫t (USD)</label>
            <input type="number" id="withdraw-amount" placeholder="T·ªëi thi·ªÉu $50" oninput="calcVndReceive()">
            <p style="text-align: right; font-size: 12px; color: var(--text-muted); margin-top: 5px;">Th·ª±c nh·∫≠n: <span id="vnd-receive" style="color: var(--green); font-weight: bold;">0 ‚Ç´</span></p>
        </div>

        <div class="input-group" style="margin-top: 15px;">
            <label>Ng√¢n h√†ng nh·∫≠n</label>
            <select id="bank-name" class="styled-select">
                <option value="Vietcombank">Vietcombank (VCB)</option>
                <option value="Techcombank">Techcombank (TCB)</option>
                <option value="MB Bank">MB Bank (MB)</option>
                <option value="VietinBank">VietinBank</option>
                <option value="BIDV">BIDV</option>
                <option value="ACB">ACB</option>
                <option value="TPBank">TPBank</option>
                <option value="VPBank">VPBank</option>
            </select>
        </div>

        <div class="input-group">
            <label>S·ªë t√†i kho·∫£n</label>
            <input type="text" id="account-number" value="0987654321999" readonly>
        </div>

        <div class="input-group">
            <label>T√™n ch·ªß t√†i kho·∫£n</label>
            <input type="text" id="account-name" value="NGUYEN VAN A" readonly>
        </div>

        <div id="loading-spinner" class="loader-container" style="display: none; margin-top: 15px;">
            <div class="spinner" style="border-top-color: var(--red);"></div>
            <p>ƒêang x·ª≠ l√Ω giao d·ªãch l√™n h·ªá th·ªëng...</p>
        </div>

        <div class="action-buttons" style="margin-top: 25px;">
            <button class="btn btn-cancel" style="padding: 15px;" onclick="goBack()">Quay l·∫°i</button>
            <button id="btn-submit-withdraw" class="btn btn-sell" style="padding: 15px;" onclick="confirmWithdraw()">X√°c Nh·∫≠n R√∫t ‚ûî</button>
        </div>
    </div>

    <div id="custom-popup" class="custom-popup">
        <div class="popup-content">
            <div id="popup-icon" class="popup-icon">‚ö†Ô∏è</div>
            <h3 id="popup-title" class="popup-title">Th√¥ng b√°o</h3>
            <p id="popup-desc" class="popup-desc">N·ªôi dung th√¥ng b√°o ·ªü ƒë√¢y</p>
            <div id="popup-actions" class="popup-actions">
                </div>
        </div>
    </div>

    <script>
        // C·∫§U H√åNH KH·ªöP V·ªöI H·ªÜ TH·ªêNG
        const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzENF5j2O8npZIRGKr_a7RGYnJwWB8v5sv8ThsvwxPSmJ8ykQDaT4ws4EW9kbQSkc-S/exec"; 
        const API_KEY = "NMT_SECRET_2026";
        const EXCHANGE_RATE = 25000;
        
        let state = { usdBalance: 0, history: [] };
        let pendingWithdrawAmount = 0;

        // 1. T·∫¢I S·ªê D∆Ø T·ª™ LOCALSTORAGE
        function loadBalance() {
            const saved = localStorage.getItem('nmt_vip_bo_lite');
            if (saved) {
                const parsedData = JSON.parse(saved);
                state = Object.assign(state, parsedData);
                document.getElementById('available-balance').innerText = "$" + state.usdBalance.toLocaleString(undefined, {minimumFractionDigits: 2});
            } else {
                showPopup("‚ùå L·ªói d·ªØ li·ªáu", "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu t√†i kho·∫£n! Vui l√≤ng quay l·∫°i trang ch·ªß.", "L·ªói", [
                    { text: "Quay v·ªÅ Trang ch·ªß", class: "btn-sell", onclick: "goBack()" }
                ]);
            }
        }

        // 2. T√çNH TO√ÅN VNƒê TH·ª∞C NH·∫¨N
        function calcVndReceive() {
            const usd = parseFloat(document.getElementById('withdraw-amount').value) || 0;
            const vnd = usd * EXCHANGE_RATE;
            document.getElementById('vnd-receive').innerText = vnd.toLocaleString() + " ‚Ç´";
        }

        // 3. QUAY L·∫†I TRANG CH·ª¶
        function goBack() {
            window.location.href = 'index.html';
        }

        // 4. HI·ªÇN TH·ªä POPUP T√ôY CH·ªàNH
        function showPopup(icon, title, desc, buttons) {
            document.getElementById('popup-icon').innerHTML = icon;
            document.getElementById('popup-title').innerHTML = title;
            document.getElementById('popup-desc').innerHTML = desc;
            
            const actionsContainer = document.getElementById('popup-actions');
            actionsContainer.innerHTML = ''; // X√≥a n√∫t c≈©
            
            buttons.forEach(btn => {
                const buttonEl = document.createElement('button');
                buttonEl.className = `btn ${btn.class}`;
                buttonEl.style.padding = "12px";
                buttonEl.innerHTML = btn.text;
                buttonEl.setAttribute('onclick', btn.onclick);
                actionsContainer.appendChild(buttonEl);
            });

            document.getElementById('custom-popup').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('custom-popup').style.display = 'none';
        }

        // 5. B∆Ø·ªöC X√ÅC NH·∫¨N R√öT TI·ªÄN (HI·ªÜN POPUP)
        function confirmWithdraw() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const bankName = document.getElementById('bank-name').value;
            const accNum = document.getElementById('account-number').value;

            if (isNaN(amount) || amount < 50) {
                return showPopup("‚ö†Ô∏è", "S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá", "Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn r√∫t t·ªëi thi·ªÉu l√† $50.", [
                    { text: "ƒê√£ hi·ªÉu", class: "btn-cancel", onclick: "closePopup()" }
                ]);
            }
            if (amount > state.usdBalance) {
                return showPopup("üí∏", "S·ªë d∆∞ kh√¥ng ƒë·ªß", "B·∫°n kh√¥ng c√≥ ƒë·ªß s·ªë d∆∞ kh·∫£ d·ª•ng ƒë·ªÉ th·ª±c hi·ªán l·ªánh r√∫t n√†y.", [
                    { text: "ƒê√≥ng", class: "btn-cancel", onclick: "closePopup()" }
                ]);
            }

            pendingWithdrawAmount = amount;
            
            // Hi·ªán popup x√°c nh·∫≠n
            showPopup("üè¶", "X√°c nh·∫≠n R√∫t Ti·ªÅn", `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën r√∫t <strong>$${amount}</strong> v·ªÅ ng√¢n h√†ng <strong>${bankName}</strong> (STK: ${accNum}) kh√¥ng?`, [
                { text: "H·ªßy b·ªè", class: "btn-cancel", onclick: "closePopup()" },
                { text: "X√°c nh·∫≠n R√∫t", class: "btn-sell", onclick: "processWithdraw()" }
            ]);
        }

        // 6. X·ª¨ L√ù R√öT TI·ªÄN CH√çNH TH·ª®C
        function processWithdraw() {
            closePopup(); // ƒê√≥ng popup x√°c nh·∫≠n
            
            const bankName = document.getElementById('bank-name').value;
            const accNum = document.getElementById('account-number').value;
            const accName = document.getElementById('account-name').value;

            // V√¥ hi·ªáu h√≥a n√∫t v√† hi·ªán loading
            const btnSubmit = document.getElementById('btn-submit-withdraw');
            const loader = document.getElementById('loading-spinner');
            btnSubmit.disabled = true;
            loader.style.display = 'block';

            // Tr·ª´ ti·ªÅn v√† l∆∞u l·ªãch s·ª≠
            state.usdBalance -= pendingWithdrawAmount;
            state.history.unshift({ 
                action: 'R√öT', 
                amount: -pendingWithdrawAmount, 
                price: '-', 
                result: 'CH·ªú DUY·ªÜT', 
                time: new Date().toLocaleTimeString() 
            });

            // L∆∞u l·∫°i b·ªô nh·ªõ Local
            localStorage.setItem('nmt_vip_bo_lite', JSON.stringify(state));

            // C·∫≠p nh·∫≠t giao di·ªán s·ªë d∆∞ ngay l·∫≠p t·ª©c
            document.getElementById('available-balance').innerText = "$" + state.usdBalance.toLocaleString(undefined, {minimumFractionDigits: 2});

            // G·ª≠i d·ªØ li·ªáu l√™n Google Sheets
            const noteInfo = `NH: ${bankName} | STK: ${accNum} | T√™n: ${accName}`;
            sendToGoogleSheets('R√öT TI·ªÄN', pendingWithdrawAmount, 'CH·ªú DUY·ªÜT', `-${pendingWithdrawAmount}`, state.usdBalance.toFixed(2), noteInfo);

            // Gi·∫£ l·∫≠p ƒë·ªô tr·ªÖ m·∫°ng 2s ƒë·ªÉ nh√¨n chuy√™n nghi·ªáp h∆°n
            setTimeout(() => {
                loader.style.display = 'none';
                
                // Hi·ªán popup th√†nh c√¥ng
                showPopup("‚úÖ", "T·∫°o l·ªánh th√†nh c√¥ng!", `L·ªánh r√∫t <strong>$${pendingWithdrawAmount}</strong> ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.<br>Vui l√≤ng ch·ªù Admin h·ªá th·ªëng ph√™ duy·ªát.`, [
                    { text: "Tr·ªü v·ªÅ Trang ch·ªß", class: "btn-buy", onclick: "goBack()" }
                ]);
            }, 2000);
        }

        // 7. H√ÄM G·ª¨I L√äN GOOGLE SHEETS
        function sendToGoogleSheets(action, amount, result, profit_loss, balance, note) {
            const data = {
                api_key: API_KEY, 
                time: new Date().toLocaleString("vi-VN"),
                action: action,
                amount: amount,
                result: result,
                pnl: profit_loss,
                balance: balance,
                note: note
            };

            fetch(GOOGLE_SHEET_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(data)
            }).catch(err => console.error("L·ªói g·ª≠i d·ªØ li·ªáu l√™n Sheets:", err));
        }

        // Kh·ªüi ch·∫°y khi load trang
        window.onload = loadBalance;
    </script>
</body>
</html>